<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Ambiental Moderno</title>
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('✅ Service Worker registrado'))
        .catch(err => console.error('❌ Error al registrar SW:', err));
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0;
      background: #eef1f5;
    }
    header {
      background: #0077cc;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    section {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    .cards {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .card {
      background: #f4f7fb;
      border-left: 6px solid #0077cc;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 1rem;
    }
    canvas, iframe, img {
      width: 100%;
      border-radius: 8px;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      box-sizing: border-box;
      margin-top: 10px;
    }
    .suggestions {
      position: absolute;
      top: 75px;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
    }
    .suggestions div {
      padding: 8px;
      cursor: pointer;
    }
    .suggestions div:hover {
      background: #eee;
    }
    button {
      padding: 10px;
      margin-top: 10px;
      font-size: 1em;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .radar iframe {
      border: none;
    }
    .wide-chart {
      grid-column: 1 / -1;
    }
    #tsChart {
      height: 400px !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>🌍 Dashboard Ambiental</h1>
  </header>

  <div class="grid">
    <section>
      <h2>📍 Ubicación</h2>
      <label for="ciudad">Introduce tu ciudad:</label>
      <input type="text" id="ciudad" placeholder="Ej: Salamanca" autocomplete="off" />
      <button id="btnGeo">Usar mi ubicación</button>
      <div class="suggestions" id="sugerencias"></div>
    </section>

    <section>
      <h2>📊 Datos Actuales</h2>
      <div class="cards">
        <div class="card" id="cardTemp">🌡️ Temperatura: -- °C</div>
        <div class="card" id="cardHum">💧 Humedad: -- %</div>
        <div class="card" id="cardAnalisis">🧠 Análisis: ---</div>
      </div>
    </section>

    <section class="wide-chart">
      <h2>📈 Temperatura y Humedad</h2>
      <canvas id="tsChart"></canvas>
    </section>

    <section>
      <h2>💧 Embalses en España</h2>
      <a href="https://www.embalses.net" target="_blank">
        <img src="https://www.embalses.net/webmasters/gen-general.php" alt="Embalses España" />
      </a>
    </section>

    <section>
      <h2>🌦️ Predicción del tiempo</h2>
      <a class="weatherwidget-io" href="#" data-label_1="" data-label_2="EL TIEMPO" data-theme="original">TIEMPO</a>
    </section>

    <section>
      <h2>🌬️ Mapa interactivo Windy</h2>
      <iframe id="windy" height="450" src="" allowfullscreen></iframe>
    </section>

    <section class="radar">
      <h2>🌧️ Radar de lluvias (Windy)</h2>
      <iframe id="windyRadar" height="450" src="" allowfullscreen></iframe>
    </section>
  </div>

  <script>
    const ciudadInput = document.getElementById('ciudad');
    const sugerencias = document.getElementById('sugerencias');
    const widget = document.querySelector('.weatherwidget-io');
    const windy = document.getElementById('windy');
    const windyRadar = document.getElementById('windyRadar');
    const botonGeo = document.getElementById('btnGeo');

    const ciudadGuardada = localStorage.getItem('ciudad') || '';
    if (ciudadGuardada) ciudadInput.value = ciudadGuardada;

    const channelID = '2885960';
    const readAPIKey = '0PSL9A0O3XDWY7B7';
    const results = 48;
    const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=${results}`;
    let chart;

    function formatDateTime(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleString('es-ES', {
        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }

    function actualizarTarjetas(temp, hum) {
      document.getElementById('cardTemp').textContent = `🌡️ Temperatura: ${temp} °C`;
      document.getElementById('cardHum').textContent = `💧 Humedad: ${hum} %`;
      let analisis = "🌤️ Temperatura agradable";
      if (temp > 30) analisis = "🔥 Mucho calor, posible riesgo";
      else if (temp < 10) analisis = "❄️ Temperatura baja, riesgo de heladas";
      document.getElementById('cardAnalisis').textContent = `🧠 Análisis: ${analisis}`;
    }

    function loadData() {
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const feeds = data.feeds;
          const labels = feeds.map(f => formatDateTime(f.created_at));
          const tempData = feeds.map(f => parseFloat(f.field1) || null);
          const humData = feeds.map(f => parseFloat(f.field3) || null);
          actualizarTarjetas(tempData[tempData.length - 1], humData[humData.length - 1]);

          if (!chart) {
            const ctx = document.getElementById('tsChart').getContext('2d');
            chart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'Temperatura (°C)',
                    data: tempData,
                    borderColor: 'rgba(255,99,132,1)',
                    backgroundColor: 'rgba(255,99,132,0.2)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3
                  },
                  {
                    label: 'Humedad (%)',
                    data: humData,
                    borderColor: 'rgba(54,162,235,1)',
                    backgroundColor: 'rgba(54,162,235,0.2)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: { display: true, title: { display: true, text: 'Fecha y Hora' } },
                  y: { display: true, title: { display: true, text: 'Valor' } }
                },
                plugins: {
                  legend: { position: 'top' },
                  tooltip: { mode: 'index', intersect: false }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
              }
            });
          } else {
            chart.data.labels = labels;
            chart.data.datasets[0].data = tempData;
            chart.data.datasets[1].data = humData;
            chart.update();
          }
        });
    }

    function actualizarCiudad(ciudad, lat, lon) {
      ciudadInput.value = ciudad;
      localStorage.setItem('ciudad', ciudad);
      const ciudadParam = ciudad.trim().toLowerCase().replace(/\s+/g, '-');
      widget.href = `https://www.tiempo.com/${ciudadParam}.htm`;
      widget.dataset.label_1 = ciudad.toUpperCase();
      windy.src = `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&zoom=8&overlay=wind&level=surface`;
      windyRadar.src = `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&zoom=9&overlay=rain&level=surface`;
    }

    ciudadInput.addEventListener('input', () => {
      const query = ciudadInput.value.trim();
      if (query.length < 2) {
        sugerencias.innerHTML = '';
        return;
      }
      fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&countrycodes=es&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          sugerencias.innerHTML = '';
          data.forEach(item => {
            const div = document.createElement('div');
            div.textContent = item.display_name;
            div.onclick = () => {
              sugerencias.innerHTML = '';
              actualizarCiudad(item.display_name, item.lat, item.lon);
            };
            sugerencias.appendChild(div);
          });
        });
    });

    botonGeo.addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
              const ciudad = data.address.city || data.address.town || data.address.village || 'Ubicación';
              actualizarCiudad(ciudad, lat, lon);
            });
        }, () => alert("No se pudo acceder a la ubicación."));
      } else {
        alert("Geolocalización no disponible.");
      }
    });

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
