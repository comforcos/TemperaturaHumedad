<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Ambiental</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      align-items: center;
      background: #f0f0f0;
    }
    h1, h2 {
      margin: 10px 0;
      text-align: center;
    }
    #chart-container, .extra-data {
      width: 95%; max-width: 1000px;
      margin: 10px auto;
    }
    canvas {
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .weather, .map, .radar, .summary {
      margin-top: 20px;
    }
    iframe, img {
      max-width: 100%; width: 100%; border: none;
    }
    #configuracion {
      background: #fff;
      padding: 10px;
      margin: 10px auto;
      border: 1px solid #ccc;
      width: 95%; max-width: 600px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    #configuracion input {
      width: 100%; padding: 8px; font-size: 1em;
      margin-top: 5px; box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h1>Dashboard Ambiental</h1>

  <div id="configuracion">
    <label for="ciudad">üìç Introduce tu ciudad:</label>
    <input type="text" id="ciudad" placeholder="Ej: Ciudad Real"/>
  </div>

  <div id="chart-container">
    <canvas id="tsChart"></canvas>
  </div>

  <div class="summary">
    <h2>Resumen de condiciones</h2>
    <div id="resumen"></div>
  </div>

  <div class="extra-data">
    <h2>Estado de Embalses en Espa√±a</h2>
    <a href="https://www.embalses.net" target="_blank">
      <img src="https://www.embalses.net/webmasters/gen-general.php" alt="Embalses Espa√±a" />
    </a>
  </div>

  <div class="weather">
    <h2>Predicci√≥n del tiempo</h2>
    <a class="weatherwidget-io" href="#" data-label_1="" data-label_2="EL TIEMPO" data-theme="original">TIEMPO</a>
  </div>

  <div class="map">
    <h2>Mapa meteorol√≥gico interactivo</h2>
    <iframe id="windy" width="100%" height="450" src="" allowfullscreen></iframe>
  </div>

  <div class="radar">
    <h2>Radar de lluvias (AEMET)</h2>
    <iframe src="https://www.aemet.es/es/eltiempo/observacion/radar?w=1&p=es" height="500"></iframe>
  </div>

  <script>
    const channelID = '2885960';
    const readAPIKey = '0PSL9A0O3XDWY7B7';
    const results = 48;
    const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=${results}`;
    let chart;

    function formatDateTime(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleString('es-ES', {
        day: '2-digit', month: '2-digit',
        year: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }

    function generarResumen(temp, hum) {
      let r = `üå°Ô∏è ${temp} ¬∞C ‚Äî üíß ${hum}% humedad. `;
      if (temp > 30) r += 'üî• Hace calor';
      else if (temp < 10) r += '‚ùÑÔ∏è Hace fr√≠o';
      else r += 'üå§Ô∏è Temperatura agradable';
      document.getElementById('resumen').innerText = r;
    }

    function loadData() {
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const feeds = data.feeds;
          const labels = feeds.map(f => formatDateTime(f.created_at));
          const tempData = feeds.map(f => parseFloat(f.field1) || null);
          const humData = feeds.map(f => parseFloat(f.field3) || null);
          generarResumen(tempData[tempData.length - 1], humData[humData.length - 1]);

          if (!chart) {
            const ctx = document.getElementById('tsChart').getContext('2d');
            chart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'Temperatura (¬∞C)',
                    data: tempData,
                    borderColor: 'rgba(255,99,132,1)',
                    backgroundColor: 'rgba(255,99,132,0.2)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3
                  },
                  {
                    label: 'Humedad (%)',
                    data: humData,
                    borderColor: 'rgba(54,162,235,1)',
                    backgroundColor: 'rgba(54,162,235,0.2)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: { display: true, title: { display: true, text: 'Fecha y Hora' } },
                  y: { display: true, title: { display: true, text: 'Valor' } }
                },
                plugins: {
                  legend: { position: 'top' },
                  tooltip: { mode: 'index', intersect: false }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
              }
            });
          } else {
            chart.data.labels = labels;
            chart.data.datasets[0].data = tempData;
            chart.data.datasets[1].data = humData;
            chart.update();
          }
        })
        .catch(err => {
          console.error('Error al cargar datos de ThingSpeak:', err);
        });
    }

    // Guardar y cargar ciudad desde localStorage
    const ciudadInput = document.getElementById('ciudad');
    const widget = document.querySelector('.weatherwidget-io');
    const windy = document.getElementById('windy');

    function actualizarCiudad(ciudad) {
      ciudadInput.value = ciudad;
      localStorage.setItem('ciudad', ciudad);

      const ciudadParam = ciudad.trim().toLowerCase().replace(/\s+/g, '-');
      widget.href = `https://www.tiempo.com/${ciudadParam}.htm`;
      widget.dataset.label_1 = ciudad.toUpperCase();

      // Actualizar mapa Windy (coordenadas aproximadas por nombre com√∫n)
      const mapas = {
        "madrid": { lat: 40.4, lon: -3.7 },
        "valencia": { lat: 39.5, lon: -0.4 },
        "sevilla": { lat: 37.4, lon: -5.9 },
        "zaragoza": { lat: 41.6, lon: -0.9 },
        "barcelona": { lat: 41.4, lon: 2.1 },
        "ciudad-real": { lat: 38.98, lon: -3.93 }
      };
      const coord = mapas[ciudadParam] || mapas["ciudad-real"];
      windy.src = `https://embed.windy.com/embed2.html?lat=${coord.lat}&lon=${coord.lon}&zoom=7&overlay=rain&level=surface`;
    }

    ciudadInput.addEventListener('change', () => actualizarCiudad(ciudadInput.value));

    const ciudadGuardada = localStorage.getItem('ciudad') || 'Ciudad Real';
    actualizarCiudad(ciudadGuardada);

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>