<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Ambiental Moderno</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0;
      background: #eef1f5;
    }
    header {
      background: #0077cc;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    section {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    canvas, iframe, img {
      width: 100%;
      border-radius: 8px;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      margin-top: 10px;
      box-sizing: border-box;
    }
    .radar a {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 20px;
      background: #0077cc;
      color: white;
      border-radius: 5px;
      text-decoration: none;
      text-align: center;
    }
    .wide-chart {
      grid-column: 1 / -1;
    }
    #tsChart {
      height: 400px !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>🌍 Dashboard Ambiental</h1>
  </header>

  <div class="grid">
    <section>
      <h2>📍 Ubicación</h2>
      <label for="ciudad">Introduce tu ciudad:</label>
      <input type="text" id="ciudad" placeholder="Ej: Ciudad Real"/>
    </section>

    <section class="wide-chart">
      <h2>🌡️ Temperatura y Humedad</h2>
      <canvas id="tsChart"></canvas>
    </section>

    <section>
      <h2>🧾 Resumen</h2>
      <div id="resumen">Cargando datos...</div>
    </section>

    <section>
      <h2>💧 Embalses en España</h2>
      <a href="https://www.embalses.net" target="_blank">
        <img src="https://www.embalses.net/webmasters/gen-general.php" alt="Embalses España" />
      </a>
    </section>

    <section>
      <h2>🌦️ Predicción del tiempo</h2>
      <a class="weatherwidget-io" href="#" data-label_1="" data-label_2="EL TIEMPO" data-theme="original">TIEMPO</a>
    </section>

    <section>
      <h2>🌬️ Mapa interactivo Windy</h2>
      <iframe id="windy" height="450" src="" allowfullscreen></iframe>
    </section>

    <section class="radar">
      <h2>🌧️ Radar oficial AEMET</h2>
      <a href="https://www.aemet.es/es/eltiempo/observacion/radar" target="_blank">Ver radar actualizado</a>
    </section>
  </div>

  <script>
    const channelID = '2885960';
    const readAPIKey = '0PSL9A0O3XDWY7B7';
    const results = 48;
    const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=${results}`;
    let chart;

    function formatDateTime(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleString('es-ES', {
        day: '2-digit', month: '2-digit',
        year: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }

    function generarResumen(temp, hum) {
      let r = `🌡️ ${temp} °C — 💧 ${hum}% humedad. `;
      if (temp > 30) r += '🔥 Hace calor';
      else if (temp < 10) r += '❄️ Hace frío';
      else r += '🌤️ Temperatura agradable';
      document.getElementById('resumen').innerText = r;
    }

    function loadData() {
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const feeds = data.feeds;
          const labels = feeds.map(f => formatDateTime(f.created_at));
          const tempData = feeds.map(f => parseFloat(f.field1) || null);
          const humData = feeds.map(f => parseFloat(f.field3) || null);
          generarResumen(tempData[tempData.length - 1], humData[humData.length - 1]);

          if (!chart) {
            const ctx = document.getElementById('tsChart').getContext('2d');
            chart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'Temperatura (°C)',
                    data: tempData,
                    borderColor: 'rgba(255,99,132,1)',
                    backgroundColor: 'rgba(255,99,132,0.2)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3
                  },
                  {
                    label: 'Humedad (%)',
                    data: humData,
                    borderColor: 'rgba(54,162,235,1)',
                    backgroundColor: 'rgba(54,162,235,0.2)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: { display: true, title: { display: true, text: 'Fecha y Hora' } },
                  y: { display: true, title: { display: true, text: 'Valor' } }
                },
                plugins: {
                  legend: { position: 'top' },
                  tooltip: { mode: 'index', intersect: false }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
              }
            });
          } else {
            chart.data.labels = labels;
            chart.data.datasets[0].data = tempData;
            chart.data.datasets[1].data = humData;
            chart.update();
          }
        })
        .catch(err => {
          document.getElementById('resumen').innerText = "Error al cargar datos.";
          console.error('Error al cargar datos de ThingSpeak:', err);
        });
    }

    const ciudadInput = document.getElementById('ciudad');
    const widget = document.querySelector('.weatherwidget-io');
    const windy = document.getElementById('windy');

    function actualizarCiudad(ciudad) {
      ciudadInput.value = ciudad;
      localStorage.setItem('ciudad', ciudad);

      const ciudadParam = ciudad.trim().toLowerCase().replace(/\s+/g, '-');
      widget.href = `https://www.tiempo.com/${ciudadParam}.htm`;
      widget.dataset.label_1 = ciudad.toUpperCase();

      const mapas = {
        "madrid": { lat: 40.4, lon: -3.7 },
        "valencia": { lat: 39.5, lon: -0.4 },
        "sevilla": { lat: 37.4, lon: -5.9 },
        "zaragoza": { lat: 41.6, lon: -0.9 },
        "barcelona": { lat: 41.4, lon: 2.1 },
        "ciudad-real": { lat: 38.98, lon: -3.93 }
      };
      const coord = mapas[ciudadParam] || mapas["ciudad-real"];
      windy.src = `https://embed.windy.com/embed2.html?lat=${coord.lat}&lon=${coord.lon}&zoom=7&overlay=rain&level=surface`;
    }

    ciudadInput.addEventListener('change', () => actualizarCiudad(ciudadInput.value));

    const ciudadGuardada = localStorage.getItem('ciudad') || 'Ciudad Real';
    actualizarCiudad(ciudadGuardada);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        windy.src = `https://embed.windy.com/embed2.html?lat=${latitude}&lon=${longitude}&zoom=7&overlay=rain&level=surface`;
      });
    }

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
